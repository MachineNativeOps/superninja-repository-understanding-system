name: AI-Driven Integration Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      analyze_all:
        description: 'Analyze all components'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'


jobs:
  ai-code-review:
    name: AI Code Review and Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install PyYAML
          
      - name: Analyze code changes with AI
        id: ai-analysis
        run: |
          echo "## ğŸ¤– AIä»£ç¢¼åˆ†æå ±å‘Š" > /tmp/ai-analysis.md
          echo "" >> /tmp/ai-analysis.md
          echo "### ğŸ“Š è®Šæ›´çµ±è¨ˆ" >> /tmp/ai-analysis.md
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | wc -l)
          echo "- è®Šæ›´æ–‡ä»¶æ•¸: $CHANGED_FILES" >> /tmp/ai-analysis.md
          
          # Get lines changed
          LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }} HEAD | awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.base_ref }} HEAD | awk '{sum+=$2} END {print sum}')
          echo "- æ–°å¢è¡Œæ•¸: $LINES_ADDED" >> /tmp/ai-analysis.md
          echo "- åˆªé™¤è¡Œæ•¸: $LINES_DELETED" >> /tmp/ai-analysis.md
          
          echo "" >> /tmp/ai-analysis.md
          echo "### ğŸ§  æ™ºèƒ½åˆ†æ" >> /tmp/ai-analysis.md
          echo "" >> /tmp/ai-analysis.md
          echo "æ­£åœ¨åˆ†æä»£ç¢¼è®Šæ›´çš„å½±éŸ¿..." >> /tmp/ai-analysis.md
          
          # Analyze complexity
          echo "" >> /tmp/ai-analysis.md
          echo "#### è¤‡é›œåº¦åˆ†æ" >> /tmp/ai-analysis.md
          PY_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep '\.py$' | wc -l)
          if [ $PY_FILES -gt 0 ]; then
            echo "- Pythonæ–‡ä»¶è®Šæ›´: $PY_FILES å€‹" >> /tmp/ai-analysis.md
            echo "  - å»ºè­°é€²è¡Œé¡å¤–çš„ä»£ç¢¼æª¢æŸ¥" >> /tmp/ai-analysis.md
          fi
          
          # Analyze impact on FHS integration
          echo "" >> /tmp/ai-analysis.md
          echo "#### FHSé›†æˆå½±éŸ¿åˆ†æ" >> /tmp/ai-analysis.md
          FHS_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E 'fhs-integration|FHS' | wc -l)
          if [ $FHS_FILES -gt 0 ]; then
            echo "- âš ï¸ æª¢æ¸¬åˆ°FHSé›†æˆç›¸é—œè®Šæ›´: $FHS_FILES å€‹æ–‡ä»¶" >> /tmp/ai-analysis.md
            echo "  - å»ºè­°é‹è¡Œå®Œæ•´çš„FHSé›†æˆæ¸¬è©¦" >> /tmp/ai-analysis.md
            echo "  - éœ€è¦ç‰¹åˆ¥é—œæ³¨é›†æˆå…¼å®¹æ€§" >> /tmp/ai-analysis.md
            echo "impact=true" >> $GITHUB_OUTPUT
          else
            echo "- æœªæª¢æ¸¬åˆ°FHSé›†æˆç›¸é—œè®Šæ›´" >> /tmp/ai-analysis.md
            echo "impact=false" >> $GITHUB_OUTPUT
          fi
          
          # Risk assessment
          echo "" >> /tmp/ai-analysis.md
          echo "#### é¢¨éšªè©•ä¼°" >> /tmp/ai-analysis.md
          RISK_LEVEL="low"
          if [ $PY_FILES -gt 10 ] || [ $FHS_FILES -gt 5 ]; then
            RISK_LEVEL="high"
            echo "- ğŸ”´ é«˜é¢¨éšª: å¤§é‡Pythonæ–‡ä»¶æˆ–FHSé›†æˆè®Šæ›´" >> /tmp/ai-analysis.md
          elif [ $PY_FILES -gt 5 ] || [ $FHS_FILES -gt 2 ]; then
            RISK_LEVEL="medium"
            echo "- ğŸŸ¡ ä¸­ç­‰é¢¨éšª: ä¸­ç­‰æ•¸é‡çš„è®Šæ›´" >> /tmp/ai-analysis.md
          else
            echo "- ğŸŸ¢ ä½é¢¨éšª: å°‘é‡è®Šæ›´" >> /tmp/ai-analysis.md
          fi
          echo "risk=$RISK_LEVEL" >> $GITHUB_OUTPUT
          
          echo "" >> /tmp/ai-analysis.md
          echo "### ğŸ’¡ å»ºè­°" >> /tmp/ai-analysis.md
          echo "" >> /tmp/ai-analysis.md
          if [ "$RISK_LEVEL" = "high" ]; then
            echo "- å»ºè­°é€²è¡Œå…¨é¢çš„ä»£ç¢¼æª¢æŸ¥" >> /tmp/ai-analysis.md
            echo "- å»ºè­°é‹è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶" >> /tmp/ai-analysis.md
            echo "- å»ºè­°é€²è¡Œå›æ»¾æ¸¬è©¦" >> /tmp/ai-analysis.md
          elif [ "$RISK_LEVEL" = "medium" ]; then
            echo "- å»ºè­°é€²è¡Œå¸¸è¦ä»£ç¢¼æª¢æŸ¥" >> /tmp/ai-analysis.md
            echo "- å»ºè­°é‹è¡Œç›¸é—œæ¸¬è©¦" >> /tmp/ai-analysis.md
          else
            echo "- å¯ä»¥å¿«é€Ÿåˆä½µ" >> /tmp/ai-analysis.md
          fi
          
          cat /tmp/ai-analysis.md
          
      - name: Upload AI analysis report
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-report
          path: /tmp/ai-analysis.md
          retention-days: 30
          
      - name: Create PR comment with AI analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¤– AIé©…å‹•çš„ä»£ç¢¼åˆ†æ\n\n';
            
            try {
              const analysis = fs.readFileSync('/tmp/ai-analysis.md', 'utf8');
              comment += analysis;
            } catch (error) {
              comment += 'ç„¡æ³•è®€å–AIåˆ†æå ±å‘Š\n';
            }
            
            comment += '\n---\n\n';
            comment += 'ğŸ“‹ **åˆ†ææ‘˜è¦**:\n';
            comment += `- è®Šæ›´é¢¨éšª: \${{ steps.ai-analysis.outputs.risk }}\n`;
            
            const hasImpact = '${{ steps.ai-analysis.outputs.impact }}';
            if (hasImpact === 'true') {
              comment += '- âš ï¸ åŒ…å«FHSé›†æˆè®Šæ›´\n';
            } else {
              comment += '- âœ… ç„¡FHSé›†æˆå½±éŸ¿\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: Set auto-merge label based on risk
        if: |
          github.event_name == 'pull_request' &&
          steps.ai-analysis.outputs.risk == 'low'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['auto-merge-ready']
            });


  auto-merge-decision:
    name: Automated Merge Decision
    runs-on: ubuntu-latest
    needs: ai-code-review
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge-ready') &&
      !contains(github.event.pull_request.labels.*.name, 'do-not-merge')
    
    steps:
      - name: Check CI status
        id: check-ci
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            
            const allPassed = checks.check_runs.every(
              check => check.conclusion === 'success' || check.conclusion === 'skipped'
            );
            
            if (allPassed) {
              console.log('âœ… All CI checks passed');
              return 'pass';
            } else {
              console.log('âŒ Some CI checks failed');
              return 'fail';
            }
          
      - name: Approve and merge PR
        if: steps.check-ci.outputs.result == 'pass'
        uses: actions/github-script@v7
        with:
          script: |
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'âœ… AIè‡ªå‹•æª¢æŸ¥é€šéï¼Œæ‰¹å‡†åˆä½µ'
            });
            
            // Merge the PR
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash'
            });
            
            console.log('âœ… PRå·²æˆåŠŸè‡ªå‹•åˆä½µ');