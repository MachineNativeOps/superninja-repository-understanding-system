# RAG Pipeline Flow
# Defines DAG-based execution workflow for RAG

version: "2.0.0"
semantic_role: workflow_definitions
artifact_type: flow
semantic_root: false

flow:
  name: "rag-pipeline"
  version: "1.0.0"
  description: "Retrieval-Augmented Generation pipeline workflow"
  type: "dag"

steps:
  - id: "query-preprocessing"
    name: "Query Preprocessing"
    type: "transform"
    module: "data-management"
    operation: "preprocessQuery"
    inputs:
      - name: "query"
        type: "string"
        source: "user_input"
    outputs:
      - name: "processed_query"
        type: "string"
    config:
      lowercase: true
      remove_stopwords: true
      stemming: true
    next:
      - "embedding-generation"

  - id: "embedding-generation"
    name: "Generate Query Embedding"
    type: "transform"
    module: "integration-extension"
    operation: "generateEmbedding"
    inputs:
      - name: "text"
        type: "string"
        source: "query-preprocessing.processed_query"
    outputs:
      - name: "embedding"
        type: "array<number>"
    config:
      model: "text-embedding-ada-002"
      dimensions: 1536
    next:
      - "vector-search"

  - id: "vector-search"
    name: "Vector Similarity Search"
    type: "query"
    module: "data-management"
    operation: "vectorSearch"
    inputs:
      - name: "embedding"
        type: "array<number>"
        source: "embedding-generation.embedding"
      - name: "top_k"
        type: "integer"
        value: 5
    outputs:
      - name: "documents"
        type: "array<Document>"
    config:
      index: "knowledge_base"
      similarity_metric: "cosine"
    next:
      - "context-assembly"

  - id: "context-assembly"
    name: "Assemble Context"
    type: "transform"
    module: "data-management"
    operation: "assembleContext"
    inputs:
      - name: "documents"
        type: "array<Document>"
        source: "vector-search.documents"
      - name: "query"
        type: "string"
        source: "query-preprocessing.processed_query"
    outputs:
      - name: "context"
        type: "string"
    config:
      max_tokens: 4000
      include_metadata: true
    next:
      - "prompt-construction"

  - id: "prompt-construction"
    name: "Construct Prompt"
    type: "transform"
    module: "protocol"
    operation: "constructPrompt"
    inputs:
      - name: "context"
        type: "string"
        source: "context-assembly.context"
      - name: "query"
        type: "string"
        source: "user_input"
    outputs:
      - name: "prompt"
        type: "string"
    config:
      template: "rag_qa"
      system_message: "You are a helpful assistant that answers questions based on the provided context."
    next:
      - "llm-generation"

  - id: "llm-generation"
    name: "Generate Response"
    type: "generate"
    module: "integration-extension"
    operation: "generateCompletion"
    inputs:
      - name: "prompt"
        type: "string"
        source: "prompt-construction.prompt"
    outputs:
      - name: "response"
        type: "string"
    config:
      model: "gpt-4"
      temperature: 0.7
      max_tokens: 1000
    next:
      - "response-postprocessing"

  - id: "response-postprocessing"
    name: "Postprocess Response"
    type: "transform"
    module: "data-management"
    operation: "postprocessResponse"
    inputs:
      - name: "response"
        type: "string"
        source: "llm-generation.response"
      - name: "documents"
        type: "array<Document>"
        source: "vector-search.documents"
    outputs:
      - name: "final_response"
        type: "object"
    config:
      include_sources: true
      format: "markdown"
    next: []

execution:
  mode: "sequential"
  timeout: "60s"
  retry:
    max_attempts: 3
    backoff: "exponential"
    initial_delay: "1s"
  
  error_handling:
    strategy: "fail_fast"
    on_error:
      - action: "log"
        level: "error"
      - action: "notify"
        channel: "alerts"

monitoring:
  metrics:
    - "step_duration"
    - "step_success_rate"
    - "total_duration"
    - "error_count"
  
  tracing:
    enabled: true
    sample_rate: 1.0

metadata:
  created_at: "2025-01-10T12:40:00Z"
  updated_at: "2025-01-10T12:40:00Z"
  version: "2.0.0"
  status: "active"
  references:
    - "data-management.manifest.yaml"
    - "protocol.manifest.yaml"
    - "integration-extension.manifest.yaml"