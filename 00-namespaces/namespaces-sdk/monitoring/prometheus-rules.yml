apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: namespaces-sdk-instant-system
  namespace: monitoring
  labels:
    app: namespaces-sdk
    system: instant-ops
spec:
  groups:
  - name: instant-system-performance
    rules:
    # Instant System Latency Monitoring
    - alert: InstantSystemLatencyHigh
      expr: namespaces_sdk_latency_ms > 100
      for: 0m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Instant System latency exceeded 100ms"
        description: "Current latency: {{ $value }}ms (Threshold: 100ms)"
        runbook_url: "https://github.com/MachineNativeOps/machine-native-ops/instant_system"

    - alert: InstantSystemLatencyWarning
      expr: namespaces_sdk_latency_ms > 50
      for: 1m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Instant System latency approaching threshold"
        description: "Current latency: {{ $value }}ms (Warning threshold: 50ms)"

    # Parallel Agent Pool Monitoring
    - alert: ParallelAgentPoolLow
      expr: namespaces_sdk_active_agents < 64
      for: 0m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Parallel agent pool below minimum"
        description: "Active agents: {{ $value }} (Minimum required: 64)"
        action: "Auto-scaling triggered immediately"

    - alert: ParallelAgentPoolWarning
      expr: namespaces_sdk_active_agents < 128
      for: 2m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Parallel agent pool below optimal"
        description: "Active agents: {{ $value }} (Optimal: 128-256)"

    # Success Rate Monitoring
    - alert: SuccessRateLow
      expr: namespaces_sdk_success_rate < 95
      for: 0m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Success rate below 95%"
        description: "Current success rate: {{ $value }}% (Threshold: 95%)"
        action: "Auto-healing triggered"

    - alert: SuccessRateDegraded
      expr: namespaces_sdk_success_rate < 98
      for: 1m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Success rate degraded"
        description: "Current success rate: {{ $value }}% (Optimal: ≥98%)"

    # Human Intervention Monitoring
    - alert: HumanInterventionDetected
      expr: increase(namespaces_sdk_human_intervention_count[5m]) > 0
      for: 0m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Human intervention detected"
        description: "Human interventions in last 5m: {{ $value }}"
        requirement: "Zero human intervention required"

    # Auto-Healing Monitoring
    - alert: AutoHealingFailed
      expr: increase(namespaces_sdk_auto_healing_failures[5m]) > 0
      for: 0m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Auto-healing mechanism failed"
        description: "Auto-healing failures in last 5m: {{ $value }}"
        action: "Manual intervention required"

    - alert: AutoHealingTriggered
      expr: increase(namespaces_sdk_auto_healing_triggers[1m]) > 0
      for: 0m
      labels:
        severity: info
        system: instant-ops
      annotations:
        summary: "Auto-healing triggered"
        description: "Auto-healing triggers in last 1m: {{ $value }}"

    # Event Router Monitoring
    - alert: EventRouterBacklog
      expr: namespaces_sdk_event_backlog_size > 1000
      for: 1m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Event router backlog increasing"
        description: "Backlog size: {{ $value }} events"
        action: "Scale up event processing"

    - alert: EventRouterStalled
      expr: increase(namespaces_sdk_events_processed[5m]) == 0
      for: 2m
      labels:
        severity: critical
        system: instant-ops
      annotations:
        summary: "Event router stalled"
        description: "No events processed in last 5 minutes"
        action: "Restart event router immediately"

    # Governance Compliance Monitoring
    - alert: GovernanceComplianceLow
      expr: namespaces_sdk_governance_compliance < 95
      for: 1m
      labels:
        severity: warning
        system: governance
      annotations:
        summary: "Governance compliance below threshold"
        description: "Compliance rate: {{ $value }}% (Target: ≥95%)"

    - alert: RFCBacklogHigh
      expr: namespaces_sdk_pending_rfc_count > 5
      for: 5m
      labels:
        severity: warning
        system: governance
      annotations:
        summary: "RFC backlog increasing"
        description: "Pending RFCs: {{ $value }} (Target: <5)"

    # Resource Utilization
    - alert: MemoryUsageHigh
      expr: (namespaces_sdk_memory_bytes / namespaces_sdk_memory_limit_bytes) * 100 > 85
      for: 2m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Memory usage high"
        description: "Memory usage: {{ $value }}% (Threshold: 85%)"

    - alert: CPUUsageHigh
      expr: rate(namespaces_sdk_cpu_seconds_total[2m]) * 100 > 80
      for: 2m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "CPU usage high"
        description: "CPU usage: {{ $value }}% (Threshold: 80%)"

  - name: instant-system-scaling
    rules:
    # Auto-scaling triggers
    - alert: AutoScalingRequired
      expr: namespaces_sdk_queue_depth > 1000
      for: 0m
      labels:
        severity: warning
        system: instant-ops
      annotations:
        summary: "Auto-scaling required"
        description: "Queue depth: {{ $value }} (Threshold: 1000)"
        action: "Scale up agent pool"

    - alert: AutoScalingDown
      expr: namespaces_sdk_queue_depth < 100 and namespaces_sdk_active_agents > 64
      for: 5m
      labels:
        severity: info
        system: instant-ops
      annotations:
        summary: "Auto-scaling down opportunity"
        description: "Queue depth: {{ $value }}, Active agents: {{ query 'namespaces_sdk_active_agents' }}"

  - name: instant-system-business
    rules:
    # Business metrics
    - alert: ThroughputDegraded
      expr: rate(namespaces_sdk_operations_total[5m]) < 100
      for: 2m
      labels:
        severity: warning
        system: business
      annotations:
        summary: "Throughput degraded"
        description: "Operations/second: {{ $value }} (Target: ≥100)"

    - alert: ErrorRateHigh
      expr: rate(namespaces_sdk_errors_total[5m]) / rate(namespaces_sdk_operations_total[5m]) * 100 > 5
      for: 1m
      labels:
        severity: critical
        system: business
      annotations:
        summary: "Error rate high"
        description: "Error rate: {{ $value }}% (Threshold: 5%)"